worker_processes auto;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    # =====================
    # MIME TYPES & LOGS
    # =====================
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;
    
    # =====================
    # RATE LIMITING
    # =====================
    limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=300r/s;
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=200r/s;
    log_format ratelimit '$remote_addr - $remote_user [$time_local] '
                '"$request" $status $body_bytes_sent '
                '"$http_referer" "$http_user_agent" '
                'rate_limit_status=$limit_req_status ';
                
    # =====================
    # PERFORMANCE
    # =====================
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    # =====================
    # UPSTREAM SERVICES
    # =====================
    upstream fastapi_backend {
        server ia-service:8000 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }
    
    upstream auth_backend {
        server auth-service:3333 max_fails=3 fail_timeout=30s;
        keepalive 16;
    }
    
    # =====================
    # HTTPS SERVER
    # =====================
    server {
        listen 443 ssl;
        http2 on;
        server_name localhost;
        
        # SSL Configuration
        ssl_certificate /etc/nginx/ssl/nginx-selfsigned.crt;
        ssl_certificate_key /etc/nginx/ssl/nginx-selfsigned.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
        
        # Client settings
        client_max_body_size 10M;
        client_body_timeout 60s;
        
        # Default proxy headers
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        
        # =====================
        # ROOT ENDPOINT
        # =====================
        location = / {
            default_type application/json;
            return 200 '{"status":"ok","service":"API Gateway","auth":"ENABLED"}';
        }
        
        # =====================
        # FAVICON
        # =====================
        location = /favicon.ico {
            access_log off;
            log_not_found off;
            return 204;
        }
        
        # =====================
        # HEALTH CHECK (public)
        # =====================
        location = /health {
            access_log off;
            add_header Content-Type text/plain;
            return 200 "OK\n";
        }
        
        # =====================
        # AUTH ENDPOINTS (publics)
        # =====================
        location /auth/ {
            limit_req zone=auth_limit burst=5 nodelay;
            
            proxy_pass http://auth_backend/;
            proxy_set_header X-Request-ID $request_id;
            
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # =====================
        # INTERNAL AUTH VERIFICATION
        # =====================
        location = /internal/auth/verify {
            internal;
    
            # Copier l'Authorization header original
            proxy_set_header Authorization $http_authorization;
    
             # Passer l'URI et la m√©thode originales
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header X-Original-Method $request_method;
    
             # Ne pas passer le body (inutile pour la v√©rification)
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
    
             # Passer directement au bon endpoint d'authentification
            proxy_pass http://auth_backend/auth/verify;
    
             # Timeouts courts pour la v√©rification
            proxy_connect_timeout 5s;
            proxy_send_timeout 5s;
            proxy_read_timeout 5s;
        }
        
        # =====================
        # API ROOT
        # =====================
        location = /api {
            return 301 /api/;
        }
        
        # =====================
        # API ENDPOINTS (üîí S√âCURIS√âS PAR JWT üîí)
        # =====================
       location /api/ {
         # ============================================
         # üåê CORS CONFIGURATION
         # ============================================
   

         if ($request_method = 'OPTIONS' ) {
            add_header 'Access-Control-Allow-Origin' 'http://localhost:3000' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept, Origin, User-Agent, DNT, Cache-Control, X-Requested-With, If-Modified-Since, Range' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Max-Age' '3600' always;
            add_header 'Content-Type' 'text/plain; charset=utf-8' always;
            add_header 'Content-Length' '0' always;
            return 204;
        }
        # ============================================
           # üîê AUTHENTICATION
         # ============================================
         # V√©rifier si le Header Authorization est pr√©sent (sauf pour OPTIONS)
         if ($http_authorization = "") {
           add_header Content-Type application/json always;
           return 401 '{"error": "Unauthorized", "message": "Authorization header is required", "code": 401}';
        }
    
        # Rate limiting
        limit_req zone=api_limit burst=5 nodelay;
        limit_req_status 429;
    
        # üîí JWT AUTHENTICATION OBLIGATOIRE üîí
        auth_request /internal/auth/verify;
    
        # R√©cup√©rer les informations d'authentification
        auth_request_set $auth_status $upstream_status;
        auth_request_set $user_id $upstream_http_x_user_id; 
        auth_request_set $auth_error $upstream_http_x_auth_error;
    
        access_log /var/log/nginx/auth_debug.log combined;

        # Si l'auth √©choue, retourner 401/403
        error_page 401 = @error_401;
        error_page 403 = @error_403;
    
        # ============================================
        # üîÑ PROXY CONFIGURATION
        # ============================================
    
        # Strip /api prefix 
        rewrite ^/api/(.*)$ /$1 break;
    
        proxy_pass http://fastapi_backend;
    
         # Headers √† transmettre
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-User-ID $user_id;
        proxy_set_header X-Request-ID $request_id;
    
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    
        # Buffering for large responses
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
     }
        
        # =====================
        # ERROR PAGES
        # =====================
        location @error_401 {
            default_type application/json;
            add_header Content-Type application/json always;
            return 401 '{"error":"Unauthorized","message":"Authentification requise. Veuillez fournir un token JWT valide.","code":401}';
        }
        
        location @error_403 {
            default_type application/json;
            add_header Content-Type application/json always;
            return 403 '{"error":"Forbidden","message":"Acc√®s refus√©.","code":403}';
        }
        
        location @error_404 {
            default_type application/json;
            add_header Content-Type application/json always;
            return 404 '{"error":"Not Found","message":"Ressource introuvable.","code":404}';
        }
        
        location @error_429 {
            default_type application/json;
            add_header Content-Type application/json always;
            add_header Retry-After 60 always;
            return 429 '{"error":"Too Many Requests","message":"Trop de requ√™tes. Veuillez r√©essayer plus tard.","code":429}';
        }
        
        location @error_50x {
            default_type application/json;
            add_header Content-Type application/json always;
            return 500 '{"error":"Internal Server Error","message":"Une erreur serveur est survenue.","code":500}';
        }
    }
    
    # =====================
    # HTTP TO HTTPS REDIRECT 
    # =====================
    server {
        listen 80;
        server_name localhost;
        
        location / {
            return 301 https://$host$request_uri;
        }
    }
}