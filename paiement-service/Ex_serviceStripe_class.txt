package com.paiement.services;

import java.time.LocalDate;
import java.util.Date;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import com.paiement.Entity.*;
import com.paiement.dto.StripeResponse;
import com.paiement.Enumuration.PAIEMENTSTATUS;
import com.paiement.Repository.PaiementRepos;
import com.stripe.Stripe;
import com.stripe.exception.StripeException;
import com.stripe.model.checkout.Session;
import com.stripe.param.checkout.SessionCreateParams;

import lombok.AllArgsConstructor;
import lombok.NoArgsConstructor;

@Service
@NoArgsConstructor
@AllArgsConstructor
public class PaiementService {
    
    @Value("${stripe.secretKey}")
    private String secretKey;
    
    @Value("${stripe.successUrl}")
    private String successUrl;
    
    @Value("${stripe.cancelUrl}")
    private String cancelUrl;
    @Autowired
    private  PaiementRepos paiementRepos;
    
    public StripeResponse checkout(PaiementEntity paiement) {
        Stripe.apiKey = secretKey;
        
        // Validate amount
        if (paiement.getAmount() < 200) {
            return StripeResponse.builder()
                    .status(PAIEMENTSTATUS.FAILED)
                    .message("Montant insuffisant ! Minimum 200")
                    .sessionId(null)
                    .sessionUrl(null)
                    .build();
        }
        long price = Math.round(paiement.getAmount() * 100);
        try {
            // Save paiement first to generate ID
            PaiementEntity savedPaiement = paiementRepos.save(paiement);
            
            // Create checkout session
            SessionCreateParams params = SessionCreateParams.builder()
                    .addPaymentMethodType(SessionCreateParams.PaymentMethodType.CARD)
                    .setMode(SessionCreateParams.Mode.PAYMENT)
                    .setSuccessUrl(successUrl)
                    .setCancelUrl(cancelUrl)
                    .addLineItem(
                            SessionCreateParams.LineItem.builder()
                                    .setQuantity(1L)
                                    .setPriceData(
                                            SessionCreateParams.LineItem.PriceData.builder()
                                                    .setCurrency("USD") 
                                                    .setUnitAmount( price ) 
                                                    .setProductData(
                                                            SessionCreateParams.LineItem.PriceData.ProductData.builder()
                                                                    .setName(generateCheckoutName(savedPaiement))
                                                                    .build())
                                                    .build())
                                    .build())
                    .putMetadata("paiementId", savedPaiement.getId().toString())
                    .putMetadata("clientId", savedPaiement.getClientId())
                    .build();
                    
            // Get Session variable 
            Session session = Session.create(params);

            // return response 
            return StripeResponse.builder()
                    .status(PAIEMENTSTATUS.SUCCESS)
                    .message("Checkout session créé avec succès")
                    .sessionId(session.getId())
                    .sessionUrl(session.getUrl())
                    .paiementData(savedPaiement)
                    .build();
                    
        } catch (StripeException e) {
            return StripeResponse.builder()
                    .status(PAIEMENTSTATUS.FAILED)
                    .message("Erreur lors de la création du checkout: " + e.getMessage())
                    .sessionId(null)
                    .sessionUrl(null)
                    .build();
        }
    }

    private String generateCheckoutName(PaiementEntity paiement) {
        if (paiement == null || paiement.getId() == null) {
            // Utiliser un identifiant temporaire ou timestamp
            return "Paiement-" + System.currentTimeMillis();
        }
        
        String id = paiement.getId().toString();
        if (id.length() > 9) {
            return "Paiement-" + id.substring(0, 9);
        }
        return "Paiement-" + id;
    }
}